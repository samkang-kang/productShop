<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <script>
      if (location.origin.startsWith("file://")) {
        window.API_BASE = "http://localhost:8080";
      }
    </script>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>選果 || 選擇最好的果</title>

    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    />
    <link rel="stylesheet" href="./CSS/style.css" />
  </head>

  <body>
    <section id="header">
      <div class="header-container">
        <!-- 左側：Logo + 導航連結 -->
        <div class="left">
          <a href="#" id="logo-link">
            <img src="img/logo-1.png" alt="SwanGo Logo" id="fixed-logo" />
          </a>
          <nav class="nav-links">
            <a href="landing.html">Home</a>
            <a href="shop.html">Shop</a>
            <a href="about.html">About</a>
            <!-- <a href="FAQ.html">FAQ</a> -->
          </nav>
        </div>

        <!-- 右側：搜尋、購物車和人像圖標 -->
        <div class="right">
          <a href="#" class="nav-icon"><i class="fas fa-search"></i></a>
          <a href="cart.html" class="nav-icon active"
            ><i class="far fa-shopping-bag"></i
          ></a>
          <button
            class="nav-icon account-btn"
            aria-haspopup="menu"
            aria-expanded="false"
          >
            <i class="fas fa-user"></i>
          </button>
        </div>
      </div>

      <!-- 帳戶選單 -->
      <div class="account-dropdown" role="menu" hidden>
        <div class="dropdown-header">
          <div class="user-info">
            <div class="user-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-details">
              <div class="user-name">使用者名稱</div>
              <div class="user-email">user@example.com</div>
            </div>
          </div>
        </div>

        <div class="dropdown-menu">
          <a href="#" class="menu-item" role="menuitem" tabindex="0">
            <i class="fas fa-shopping-bag"></i>
            <span>所有訂單</span>
          </a>
          <a href="#" class="menu-item" role="menuitem" tabindex="0">
            <i class="fas fa-heart"></i>
            <span>訂閱商品</span>
          </a>
          <a href="#" class="menu-item" role="menuitem" tabindex="0">
            <i class="fas fa-cog"></i>
            <span>帳戶設定</span>
          </a>
          <a href="#" class="menu-item" role="menuitem" tabindex="0">
            <i class="fas fa-key"></i>
            <span>修改密碼</span>
          </a>
          <div class="menu-divider"></div>
          <a href="#" class="menu-item logout" role="menuitem" tabindex="0">
            <i class="fas fa-sign-out-alt"></i>
            <span>登出</span>
          </a>
        </div>
      </div>

      <!-- 手機版 -->
      <div id="mobile">
        <a href="cart.html"><i class="far fa-shopping-bag"></i></a>
        <i id="bar" class="fas fa-outdent"></i>
      </div>
    </section>

    <!-- 輪播 -->
    <div class="slideshow">
      <div class="slides">
        <div class="slide__item fades">
          <div class="slide__pagenumber">1 / 3</div>
          <img src="./img/banner/banner-2.jpg" alt="" />
          <div class="slide__content"></div>
        </div>
        <div class="slide__item fades">
          <div class="slide__pagenumber">2 / 3</div>
          <img src="./img/banner/banner-4.jpg" alt="" />
          <div class="slide__content"></div>
        </div>
        <div class="slide__item fades">
          <div class="slide__pagenumber">3 / 3</div>
          <img src="./img/banner/banner-5.jpg" alt="" />
          <div class="slide__content"></div>
        </div>
      </div>
    </div>
    <a id="prev" class="slide__arraw slide__arraw--prev"> ❮ </a>
    <a id="next" class="slide__arraw slide__arraw--next"> ❯ </a>
    <div class="slide__dot">
      <div class="dot" data-value="1"></div>
      <div class="dot" data-value="2"></div>
      <div class="dot" data-value="3"></div>
    </div>

    <!-- 購物車 -->
    <section id="cart" class="section-p1">
      <table width="100%">
        <colgroup>
          <col style="width: 8%" />
          <col style="width: 12%" />
          <col style="width: 30%" />
          <col style="width: 12%" />
          <col style="width: 14%" />
          <col style="width: 24%" />
        </colgroup>

        <thead>
          <tr>
            <td>移除</td>
            <td>圖片</td>
            <td>商品名稱</td>
            <td>單價</td>
            <td>數量</td>
            <td>小計</td>
          </tr>
        </thead>

        <tbody id="cart-tbody"></tbody>
      </table>
    </section>

    <section id="cart-add" class="section-p1">
      <div id="cuopon">
        <h3>使用優惠券</h3>
        <div>
          <input type="text" placeholder="請輸入優惠碼" />
          <button id="applyBtn" class="normal">套用</button>
        </div>
      </div>

      <div id="subtotal">
        <h3>購物車總計</h3>
        <table>
          <tr>
            <td>購物車小計</td>
            <td id="summary-subtotal">$ 0</td>
          </tr>
          <tr>
            <td>運費</td>
            <td id="summary-shipping">免運費</td>
          </tr>
          <tr>
            <td><strong>總計</strong></td>
            <td><strong id="summary-total">$ 0</strong></td>
          </tr>
        </table>
        <button class="normal">前往結帳</button>
      </div>
    </section>

    <footer class="section-p1">
      <div class="col">
        <img class="logo" src="img/Logo2.png" alt="" />
        <h4>Contact</h4>
        <p><strong>Address:</strong> 408 台中市 南屯區 公益路二段 51號18樓</p>
        <p><strong>Phone:</strong> +04 1234 5678 /(+886) 12 2345 6789</p>
        <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
        <div class="follow">
          <h4>Follow Us</h4>
          <div class="icon">
            <i class="fab fa-facebook-f"></i>
            <i class="fab fa-twitter"></i>
            <i class="fab fa-instagram"></i>
          </div>
        </div>
      </div>
      <div class="col">
        <h4>About</h4>
        <a href="#">About Us</a>
        <a href="#">Delivery Information</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms & Conditions</a>
        <a href="#">Contact Us</a>
      </div>
      <div class="col">
        <h4>My Account</h4>
        <a href="#">Sign In</a>
        <a href="#">View Cart</a>
        <a href="#">My Wishlist</a>
        <a href="#">Track My Order</a>
        <a href="#">Help</a>
      </div>
      <div class="col install">
        <h4>Install App</h4>
        <p>From App Store or Google Play</p>
        <div class="row">
          <img src="img/pay/app.jpg" alt="" />
          <img src="img/pay/play.jpg" alt="" />
        </div>
        <p>Secured Payment Gateways</p>
        <img src="img/pay/pay.png" alt="" />
      </div>

      <div class="copyright">
        <p>© 2025.Big company</p>
      </div>
    </footer>

    <div class="bottom-bar">
      <div id="bottom-total">總金額：$0</div>
      <button onclick="alert('尚未開放')">結帳</button>
    </div>

    <script src="./JS/script.js"></script>
    <script src="./JS/account-dropdown.js"></script>

    <!-- 引入統一的 auth.js -->
    <script src="./JS/auth.js"></script>

    <!-- 前端守門員：未登入就導回 /index.html -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const t = window.Auth?.getToken?.();
        if (!t || window.Auth.isTokenExpired(t)) {
          // 記住想看的頁面，之後登入成功導回這裡
          sessionStorage.setItem(
            "return_to",
            location.pathname + location.search + location.hash
          );
          location.href = "/index.html";
        }
      });
    </script>

    <!-- JWT 用戶資訊顯示邏輯 -->
    <script>
      // 定義填充帳戶 email 的函式
      function fillAccountEmail() {
        const userEmailElement = document.querySelector(".user-email");
        const userNameElement = document.querySelector(".user-name");
        const logoutBtn = document.querySelector(".logout");
        const accountBtn = document.querySelector(".account-btn");
        const userInfoSection = document.querySelector(".user-info");

        if (!userEmailElement) return;

        const token = Auth.getToken();
        if (!token || Auth.isTokenExpired(token)) {
          // 未登入狀態 - 隱藏使用者資訊區塊
          if (userInfoSection) {
            userInfoSection.style.display = "none";
          }

          // 隱藏需要登入的功能選項
          hideLoginRequiredItems();

          // 取消 dropdown-header 的 padding
          const dropdownHeader = document.querySelector(".dropdown-header");
          if (dropdownHeader) {
            dropdownHeader.classList.add("no-padding");
          }

          // 將登出按鈕改為登入按鈕
          if (logoutBtn) {
            logoutBtn.innerHTML =
              '<i class="fas fa-sign-in-alt"></i><span>登入</span>';
            logoutBtn.classList.add("login-btn");
            logoutBtn.classList.remove("logout");
            logoutBtn.href = "/index.html";
            logoutBtn.style.display = "block";
          }
          return;
        }

        // 已登入狀態
        try {
          const claims = Auth.parseJwt(token);
          const email = claims.email || claims.sub || "user@example.com";
          const name = claims.name || claims.firstName || "使用者";

          // 顯示使用者資訊區塊
          if (userInfoSection) {
            userInfoSection.style.display = "flex";
          }

          // 恢復 dropdown-header 的 padding
          const dropdownHeader = document.querySelector(".dropdown-header");
          if (dropdownHeader) {
            dropdownHeader.classList.remove("no-padding");
          }

          userEmailElement.textContent = email;
          if (userNameElement) userNameElement.textContent = name;

          // 顯示所有功能選項
          showAllItems();

          // 恢復登出按鈕
          if (logoutBtn) {
            logoutBtn.innerHTML =
              '<i class="fas fa-sign-out-alt"></i><span>登出</span>';
            logoutBtn.classList.remove("login-btn");
            logoutBtn.classList.add("logout");
            logoutBtn.href = "#";
            logoutBtn.style.display = "block";
          }
        } catch (error) {
          // 隱藏使用者資訊區塊
          if (userInfoSection) {
            userInfoSection.style.display = "none";
          }
          hideLoginRequiredItems();
        }

        // 若 token 未過期，再以 Auth.authFetch 取得 { email } 成功後覆寫
        if (!Auth.isTokenExpired(token)) {
          Auth.authFetch("/api/me")
            .then((response) => {
              if (response.ok) {
                return response.json();
              }
              throw new Error("API 請求失敗");
            })
            .then((data) => {
              if (data.email) {
                userEmailElement.textContent = data.email;
              }
              if (data.name && userNameElement) {
                userNameElement.textContent = data.name;
              }
            })
            .catch((error) => {
              if (error.status === 401) {
                // 401 時隱藏使用者資訊並隱藏登入功能選項
                if (userInfoSection) {
                  userInfoSection.style.display = "none";
                }
                hideLoginRequiredItems();
                // 清除過期的 token
                Auth.clearToken();
              }
            });
        }
      }

      // 隱藏需要登入的功能選項
      function hideLoginRequiredItems() {
        // 隱藏除了登入/登出按鈕之外的所有選單項目
        const loginRequiredItems = document.querySelectorAll(
          ".menu-item:not(.logout):not(.login-btn)"
        );
        loginRequiredItems.forEach((item) => {
          item.style.display = "none";
        });

        // 隱藏分隔線
        const divider = document.querySelector(".menu-divider");
        if (divider) {
          divider.style.display = "none";
        }
      }

      // 顯示所有功能選項
      function showAllItems() {
        const allItems = document.querySelectorAll(".menu-item");
        allItems.forEach((item) => {
          item.style.display = "block";
        });

        // 顯示分隔線
        const divider = document.querySelector(".menu-divider");
        if (divider) {
          divider.style.display = "block";
        }
      }

      // 處理登出功能
      function handleLogout() {
        if (confirm("確定要登出嗎？")) {
          // 清除 JWT token
          Auth.clearToken();

          // 更新 UI 顯示
          fillAccountEmail();
        }
      }

      // 綁定在選單展開時觸發 fillAccountEmail()
      document.addEventListener("DOMContentLoaded", function () {
        const accountBtn = document.querySelector(".account-btn");
        const logoutBtn = document.querySelector(".logout");

        if (accountBtn) {
          accountBtn.addEventListener("click", function () {
            // 點擊後延遲一下再填充，確保選單已展開
            setTimeout(fillAccountEmail, 100);
          });
        }

        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();

            // 檢查是否為登入按鈕
            if (this.classList.contains("login-btn")) {
              // 跳轉到登入頁面
              window.location.href = "/index.html";
              return;
            }

            // 處理登出
            handleLogout();
          });
        }

        // 在 DOMContentLoaded 也先呼叫一次 fillAccountEmail() 以避免空白
        fillAccountEmail();
      });

      // 監聽 window 'storage' 事件（key='jwt_token'）時再次呼叫 fillAccountEmail()
      window.addEventListener("storage", function (e) {
        if (e.key === "jwt_token") {
          fillAccountEmail();
        }
      });
    </script>
  </body>
</html>
