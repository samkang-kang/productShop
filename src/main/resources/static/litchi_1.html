<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      if (location.origin.startsWith("file://")) {
        window.API_BASE = "http://localhost:8080";
      }
    </script>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tech2etc Ecommerce Tutorial</title>
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    />

    <link rel="stylesheet" href="./CSS/style.css" />
  </head>

  <body data-product-id="12">
    <section id="header">
      <div class="header-container">
        <!-- 左側：Logo + 導航連結 -->
        <div class="left">
          <a href="#" id="logo-link">
            <img src="img/logo-1.png" alt="SwanGo Logo" id="fixed-logo" />
          </a>
          <nav class="nav-links">
            <a href="landing.html">Home</a>
            <a href="shop.html">Shop</a>
            <a href="about.html">About</a>
          </nav>
        </div>

        <!-- 右側：購物車和人像圖標 -->
        <div class="right">
          <a href="#" class="nav-icon"><i class="fas fa-search"></i></a>
          <a href="cart.html" class="nav-icon"
            ><i class="far fa-shopping-bag"></i
          ></a>
          <button
            class="nav-icon account-btn"
            aria-haspopup="menu"
            aria-expanded="false"
          >
            <i class="fas fa-user"></i>
          </button>
        </div>

        <!-- 帳戶選單 -->
        <div class="account-dropdown" role="menu" hidden>
          <div class="dropdown-header">
            <div class="user-info">
              <div class="user-avatar">
                <i class="fas fa-user-circle"></i>
              </div>
              <div class="user-details">
                <div class="user-name">使用者名稱</div>
                <div class="user-email">user@example.com</div>
              </div>
            </div>
          </div>

          <div class="dropdown-menu">
            <a href="#" class="menu-item" role="menuitem" tabindex="0">
              <i class="fas fa-shopping-bag"></i>
              <span>所有訂單</span>
            </a>
            <a href="#" class="menu-item" role="menuitem" tabindex="0">
              <i class="fas fa-heart"></i>
              <span>訂閱商品</span>
            </a>
            <a href="#" class="menu-item" role="menuitem" tabindex="0">
              <i class="fas fa-cog"></i>
              <span>帳戶設定</span>
            </a>
            <a href="#" class="menu-item" role="menuitem" tabindex="0">
              <i class="fas fa-key"></i>
              <span>修改密碼</span>
            </a>
            <div class="menu-divider"></div>
            <a href="#" class="menu-item logout" role="menuitem" tabindex="0">
              <i class="fas fa-sign-out-alt"></i>
              <span>登出</span>
            </a>
          </div>
        </div>
      </div>

      <!-- 手機版 -->
      <div id="mobile">
        <a href="cart.html"><i class="far fa-shopping-bag"></i></a>
        <a href="login.html"><i class="fas fa-user"></i></a>
        <i id="bar" class="fas fa-outdent"></i>
      </div>
    </section>

    <section id="prodetails" class="section-p1">
      <div class="single-pro-image">
        <img src="./img/menu/litchi/J1.jpg" width="100%" id="MainImg" alt="" />

        <div class="small-img-group">
          <div class="small-img-col">
            <img
              src="./img/menu/litchi/J1.jpg"
              width="100%"
              class="small-img"
              alt=""
            />
          </div>
          <div class="small-img-col">
            <img
              src="./img/menu/litchi/J2.jpg"
              width="100%"
              class="small-img"
              alt=""
            />
          </div>
          <div class="small-img-col">
            <img
              src="./img/menu/litchi/J3.jpeg"
              width="100%"
              class="small-img"
              alt=""
            />
          </div>
          <div class="small-img-col">
            <img
              src="./img/menu/litchi/J4.jpg"
              width="100%"
              class="small-img"
              alt=""
            />
          </div>
        </div>
      </div>

      <div class="single-pro-details">
        <h6>Home / Apple</h6>
        <h4>台灣荔枝</h4>
        <h2>NT$ 2000 / 盒</h2>
        <div class="qty" data-min="1" data-max="99">
          <button class="qty-btn" data-action="dec" aria-label="減少一個">
            −
          </button>
          <input
            id="sp-qty"
            class="qty-input"
            type="text"
            value="1"
            inputmode="numeric"
            aria-label="數量"
            readonly
          />
          <button class="qty-btn" data-action="inc" aria-label="增加一個">
            ＋
          </button>
        </div>
        <button id="btnAddSingle" class="normal">加入購物車</button>
        <h4>Product Details</h4>
        <span
          >「一騎紅塵妃子笑，無人知是荔枝來。」荔枝自古以來就被譽為珍稀佳果，而台灣出產的「玉荷包荔枝」更是其中翹楚。主要產於高雄大樹與南投中寮一帶，這裡氣候溫暖、土壤肥沃，為荔枝提供了絕佳的生長環境。
          玉荷包荔枝果殼鮮紅欲滴，果粒飽滿圓潤。剝開外殼，雪白晶瑩的果肉映入眼簾，質地緊實卻細嫩，汁水豐盈，入口香甜爽口，甜中帶有微酸，更添清爽層次。與一般荔枝不同，玉荷包果核細小，幾乎可以忽略，讓您每一口都能享受到滿滿果肉。
          荔枝的產季極短，每年僅在初夏的 5 月至 6
          月間盛產，稍縱即逝，正因如此更顯珍貴。我們嚴選來自產地直送的新鮮荔枝，顆顆晶瑩飽滿，彷彿凝聚了夏季最濃郁的甜美與熱情。每一顆都像是夏日的寶石，咬下一口，便能感受到台灣土地最純粹的祝福。</span
        >
      </div>
    </section>

    <!-- ===== 本週人氣果物推薦 ===== -->

    <div id="test-products">
      <section id="product1" class="section-p1 center-target">
        <div class="section-title">
          <h2>本週人氣果物推薦</h2>
          <p>產地直送・新鮮夏季限定</p>
        </div>

        <div class="pro-container">
          <!-- 卡片 1 -->
          <div class="pro featured">
            <img src="./img/fruit/top/R4.jpg" alt="" />
            <div class="des">
              <span class="product-tag pink">夏日人氣王</span>
              <span class="product-tag purple">香甜濃郁</span>
              <span class="rating-tag">
                <span class="rating-label">推薦指數：</span>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
              </span>
              <div class="title-row">
                <h5 class="product-name">芒果</h5>
                <h4 class="price">$78</h4>
              </div>
            </div>
            <a href="mango_1.html"><i class="fal fa-shopping-cart cart"></i></a>
          </div>

          <!-- 卡片 2 -->
          <div class="pro featured">
            <img src="./img/fruit/top/N1.jpg" alt="" />
            <div class="des">
              <span class="product-tag teal">酸甜適中</span>
              <span class="product-tag pink">多汁濃郁氣味</span>
              <span class="rating-tag">
                <span class="rating-label">推薦指數：</span>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
              </span>
              <div class="title-row">
                <h5 class="product-name">百香果</h5>
                <h4 class="price">$78</h4>
              </div>
            </div>
            <a href="#"><i class="fal fa-shopping-cart cart"></i></a>
          </div>

          <!-- 卡片 3 -->
          <div class="pro featured">
            <img src="./img/fruit/mid/B2.jpg" alt="" />
            <div class="des">
              <span class="product-tag blue">口感多纖維</span>
              <span class="product-tag green">酸甜滋味</span>
              <span class="rating-tag">
                <span class="rating-label">推薦指數：</span>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star-half-alt"></i>
              </span>
              <div class="title-row">
                <h5 class="product-name">鳳梨</h5>
                <h4 class="price">$78</h4>
              </div>
            </div>
            <a href="#"><i class="fal fa-shopping-cart cart"></i></a>
          </div>

          <!-- 卡片 4 -->
          <div class="pro featured">
            <img src="./img/fruit/mid/X3.jpg" alt="" />
            <div class="des">
              <span class="product-tag teal">沙脆口感</span>
              <span class="product-tag yellow">清甜風雅</span>
              <span class="rating-tag">
                <span class="rating-label">推薦指數：</span>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
              </span>
              <div class="title-row">
                <h5 class="product-name">蘋果</h5>
                <h4 class="price">$78</h4>
              </div>
            </div>
            <a href="#"><i class="fal fa-shopping-cart cart"></i></a>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== 頁面底部區塊 ===== -->
    <section id="newsletter" class="section-p1 section-m1">
      <div class="newstext">
        <h4>Sign Up For Newsletters</h4>
        <p>
          Get E-mail updates about our latest shop and
          <span>special offers.</span>
        </p>
      </div>
      <div class="form">
        <input type="text" placeholder="Your email address" />
        <button class="normal">Sign Up</button>
      </div>
    </section>

    <footer class="section-p1">
      <div class="col">
        <img class="logo" src="" alt="" />
        <h4>Contact</h4>
        <p><strong>Address: </strong> 408 台中市 南屯區 公益路二段 51號18樓</p>
        <p><strong>Phone:</strong> +04 1234 5678 /(+886) 12 2345 6789</p>
        <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
        <div class="follow">
          <h4>Follow Us</h4>
          <div class="icon">
            <i class="fab fa-facebook-f"></i>
            <i class="fab fa-twitter"></i>
            <i class="fab fa-instagram"></i>
            <i class="fab fa-pinterest-p"></i>
            <i class="fab fa-youtube"></i>
          </div>
        </div>
      </div>

      <div class="col">
        <h4>About</h4>
        <a href="#">About Us</a>
        <a href="#">Delivery Information</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms & Conditions</a>
        <a href="#">Contact Us</a>
      </div>

      <div class="col">
        <h4>My Account</h4>
        <a href="#">Sign In</a>
        <a href="#">View Cart</a>
        <a href="#">My Wishlist</a>
        <a href="#">Track My Order</a>
        <a href="#">Help</a>
      </div>

      <div class="col install">
        <h4>Install App</h4>
        <p>From App Store or Google Play</p>
        <div class="row">
          <img src="img/pay/app.jpg" alt="" />
          <img src="img/pay/play.jpg" alt="" />
        </div>
        <p>Secured Payment Gateways</p>
        <img src="img/pay/pay.png" alt="" />
      </div>

      <div class="copyright">
        <p>© 2025.Big company</p>
      </div>
    </footer>

    <script>
      var MainImg = document.getElementById("MainImg");
      var smallimg = document.getElementsByClassName("small-img");

      smallimg[0].onclick = function () {
        MainImg.src = smallimg[0].src;
      };
      smallimg[1].onclick = function () {
        MainImg.src = smallimg[1].src;
      };
      smallimg[2].onclick = function () {
        MainImg.src = smallimg[2].src;
      };
      smallimg[3].onclick = function () {
        MainImg.src = smallimg[3].src;
      };
    </script>

    <script src="./JS/script.js"></script>
    <script src="./JS/account-dropdown.js"></script>

    <!-- 引入統一的 auth.js -->
    <script src="./JS/auth.js"></script>

    <!-- 購物車連結回跳邏輯 -->
    <script>
      (function () {
        function needLogin() {
          const t = window.Auth?.getToken?.();
          return !t || window.Auth.isTokenExpired(t);
        }
        const cartLink = document.querySelector(
          'a[href="/cart.html"], .to-cart, #go-cart'
        );
        if (cartLink) {
          cartLink.addEventListener("click", function (e) {
            if (needLogin()) {
              e.preventDefault();
              sessionStorage.setItem("return_to", "/cart.html");
              location.href = "/index.html";
            }
          });
        }
      })();
    </script>

    <!-- 引入載入器樣式 -->
    <style>
      /* ===== 全頁載入器樣式 ===== */
      .page-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }

      .page-loader.show {
        display: flex;
        opacity: 1;
      }

      .loader-content {
        text-align: center;
      }

      .loading-animation {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 8px;
        margin-bottom: 20px;
      }

      .loading-bar {
        width: 8px;
        height: 40px;
        background-color: #222;
        border-radius: 4px;
        animation: loading-bounce 1.4s ease-in-out infinite both;
      }

      .loading-bar.bar1 {
        animation-delay: -0.32s;
      }

      .loading-bar.bar2 {
        animation-delay: -0.16s;
      }

      @keyframes loading-bounce {
        0%,
        80%,
        100% {
          transform: scaleY(0.4);
        }
        40% {
          transform: scaleY(1);
        }
      }

      .loading-text {
        font-size: 14px;
        color: #222;
        font-weight: 500;
      }
    </style>

    <!-- JWT 用戶資訊顯示邏輯 -->
    <script>
      // 定義填充帳戶 email 的函式
      function fillAccountEmail() {
        const userEmailElement = document.querySelector(".user-email");
        const userNameElement = document.querySelector(".user-name");
        const logoutBtn = document.querySelector(".logout");
        const accountBtn = document.querySelector(".account-btn");
        const userInfoSection = document.querySelector(".user-info");

        if (!userEmailElement) return;

        const token = Auth.getToken();
        if (!token || Auth.isTokenExpired(token)) {
          // 未登入狀態 - 隱藏使用者資訊區塊
          if (userInfoSection) {
            userInfoSection.style.display = "none";
          }

          // 隱藏需要登入的功能選項
          hideLoginRequiredItems();

          // 取消 dropdown-header 的 padding
          const dropdownHeader = document.querySelector(".dropdown-header");
          if (dropdownHeader) {
            dropdownHeader.classList.add("no-padding");
          }

          // 將登出按鈕改為登入按鈕
          if (logoutBtn) {
            logoutBtn.innerHTML =
              '<i class="fas fa-sign-in-alt"></i><span>登入</span>';
            logoutBtn.classList.add("login-btn");
            logoutBtn.classList.remove("logout");
            logoutBtn.href = "/index.html";
            logoutBtn.style.display = "block";
          }
          return;
        }

        // 已登入狀態
        try {
          const claims = Auth.parseJwt(token);
          const email = claims.email || claims.sub || "user@example.com";
          const name = claims.name || claims.firstName || "使用者";

          // 顯示使用者資訊區塊
          if (userInfoSection) {
            userInfoSection.style.display = "flex";
          }

          // 恢復 dropdown-header 的 padding
          const dropdownHeader = document.querySelector(".dropdown-header");
          if (dropdownHeader) {
            dropdownHeader.classList.remove("no-padding");
          }

          userEmailElement.textContent = email;
          if (userNameElement) userNameElement.textContent = name;

          // 顯示所有功能選項
          showAllItems();

          // 恢復登出按鈕
          if (logoutBtn) {
            logoutBtn.innerHTML =
              '<i class="fas fa-sign-out-alt"></i><span>登出</span>';
            logoutBtn.classList.remove("login-btn");
            logoutBtn.classList.add("logout");
            logoutBtn.href = "#";
            logoutBtn.style.display = "block";
          }
        } catch (error) {
          // 隱藏使用者資訊區塊
          if (userInfoSection) {
            userInfoSection.style.display = "none";
          }
          hideLoginRequiredItems();
        }

        // 若 token 未過期，再以 Auth.authFetch 取得 { email } 成功後覆寫
        if (!Auth.isTokenExpired(token)) {
          Auth.authFetch("/api/me")
            .then((response) => {
              if (response.ok) {
                return response.json();
              }
              throw new Error("API 請求失敗");
            })
            .then((data) => {
              if (data.email) {
                userEmailElement.textContent = data.email;
              }
              if (data.name && userNameElement) {
                userNameElement.textContent = data.name;
              }
            })
            .catch((error) => {
              if (error.status === 401) {
                // 401 時隱藏使用者資訊並隱藏登入功能選項
                if (userInfoSection) {
                  userInfoSection.style.display = "none";
                }
                hideLoginRequiredItems();
                // 清除過期的 token
                Auth.clearToken();
              }
            });
        }
      }

      // 隱藏需要登入的功能選項
      function hideLoginRequiredItems() {
        // 隱藏除了登入/登出按鈕之外的所有選單項目
        const loginRequiredItems = document.querySelectorAll(
          ".menu-item:not(.logout):not(.login-btn)"
        );
        loginRequiredItems.forEach((item) => {
          item.style.display = "none";
        });

        // 隱藏分隔線
        const divider = document.querySelector(".menu-divider");
        if (divider) {
          divider.style.display = "none";
        }
      }

      // 顯示所有功能選項
      function showAllItems() {
        const allItems = document.querySelectorAll(".menu-item");
        allItems.forEach((item) => {
          item.style.display = "block";
        });

        // 顯示分隔線
        const divider = document.querySelector(".menu-divider");
        if (divider) {
          divider.style.display = "block";
        }
      }

      // 處理登出功能
      function handleLogout() {
        if (confirm("確定要登出嗎？")) {
          // 清除 JWT token
          Auth.clearToken();

          // 更新 UI 顯示
          fillAccountEmail();
        }
      }

      // 顯示頁面跳轉載入器
      function showPageLoader() {
        const loader = document.getElementById("page-loader");

        // 顯示載入器
        loader.classList.add("show");

        // 鎖住背景捲動
        document.body.style.overflow = "hidden";

        // 0.5秒後跳轉到登入頁面
        setTimeout(() => {
          window.location.href = "/index.html";
        }, 500);
      }

      // 綁定在選單展開時觸發 fillAccountEmail()
      document.addEventListener("DOMContentLoaded", function () {
        const accountBtn = document.querySelector(".account-btn");
        const logoutBtn = document.querySelector(".logout");

        if (accountBtn) {
          accountBtn.addEventListener("click", function () {
            // 點擊後延遲一下再填充，確保選單已展開
            setTimeout(fillAccountEmail, 100);
          });
        }

        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();

            // 檢查是否為登入按鈕
            if (this.classList.contains("login-btn")) {
              // 顯示載入動畫
              showPageLoader();
              return;
            }

            // 處理登出
            handleLogout();
          });
        }

        // 在 DOMContentLoaded 也先呼叫一次 fillAccountEmail() 以避免空白
        fillAccountEmail();
      });

      // 監聽 window 'storage' 事件（key='jwt_token'）時再次呼叫 fillAccountEmail()
      window.addEventListener("storage", function (e) {
        if (e.key === "jwt_token") {
          fillAccountEmail();
        }
      });
    </script>

    <!-- 全頁載入器 -->
    <div id="page-loader" class="page-loader">
      <div class="loader-content">
        <div class="loading-animation">
          <div class="loading-bar bar1"></div>
          <div class="loading-bar bar2"></div>
        </div>
        <div class="loading-text">頁面跳轉中…</div>
      </div>
    </div>
  </body>
</html>
